\chapter{Deployment tool}
\label{chap:deploymenttool}

\section{Implementation of downlink exposure}
\label{sec:downlinkimplementation}

Schrijf over hoe die exposure nu toegevoegd is aan de tool. 
-Wat deed de tool al? Users en femtocell's uniform verdelen op publiek transport, uabs etc
- dat de exposure pas op het einde wordt berekend nadat het netwerk gemodeleerd is.

Algorithm \ref{alg:getexposure} describes the implementation on how to calculate the exposure of a user towards a single base station as described in formula \ref{eq:singleexposure}.
Several values need to be known for this to work. In the first place, the path loss is calculated.  However, the different path loss values are already calculated during the network initialization phase and can, therefore, be reused on the condition they were saved. By only calculating the path loss once,  the time complexity of the tool decreases drastically. 
Afther this, the gain is calculated by adding the antenna gain to the  current input power of the antenna and by substracting the feeder loss as already stated in equation \ref{eq:eirp}.
In the last place, equation \ref{eq:singleexposure} is used and the exposure is returned.

\begin{algorithm}
	\caption{getExposure} 
	\label{alg:getexposure}
     \hspace*{\algorithmicindent} \textbf{Input} user, basestation\\
     \hspace*{\algorithmicindent} \textbf{Output} exposure of a user towards a single basestation
	\begin{algorithmic}[1]
        \State $PL \gets$ path loss between user and basestation
        \State $gain \gets$ getBSantennagain + basestation.getInputPower - getBSFeederLoss
		\State $exposure \gets 10^{\frac{EIRP - 43.15 + 20*\log(f)- PL}{20}}$ \\
    \Return $exposure$ 
	\end{algorithmic} 
\end{algorithm}

To combine all exposures for a specific user, equation \ref{eq:totalexposure} is translated into algortim \ref{alg:gettotalexposure}.
Finaly, this needs to be repeaded for every users. Algorithm \ref{alg:main} is used to iterate over each user and each simulation and saves the computed value
into the appropriate attribute.

\begin{algorithm}
	\caption{getTotalExposure} 
	\label{alg:gettotalexposure}
     \hspace*{\algorithmicindent} \textbf{Input} user, basestations[]\\
     \hspace*{\algorithmicindent} \textbf{Output} combined exposures from each basestation for a given user
	\begin{algorithmic}[1]
        \State $E_{tot}\gets 0.0$
		\ForAll {basestation  in  basestations}
            \State $E \gets$ getExposure(user, basestation)
            \State $E_{tot}\gets E_{tot} + E^2$	
		\EndFor
        \State $E_{tot}\gets sqrt(E_{tot})$\\
    \Return $E_{tot}$ 
	\end{algorithmic} 
\end{algorithm}

\begin{algorithm}
	\caption{Calculate and save the total exposure for each user in each simulation} 
	\label{alg:main}
     \hspace*{\algorithmicindent} \textbf{Input} users[][], basestations[][]\\
     \hspace*{\algorithmicindent} \textbf{Output} /
	\begin{algorithmic}[1]
		\For {$simulation=1,2,\ldots basestations$}
			\ForAll {user  in  users[simulation]}
				\State $user.exposure \gets  getTotalExposure(user,basestations[simulation])$
			\EndFor
		\EndFor
	\end{algorithmic} 
\end{algorithm}

To provide a summary of how the network is performing on electromagnetic exposure, a weighted average is calculated. This is implemented in algorithm \ref{alg:getglobaluserexposure} which
takes all users for a specified simulation and two weighting factors $w_1$ and $w_2$. They respectively correspond to the 50th percentile and 95th of the ordered users' exposure. The two weights get equal importance of 0.5. This is because also higher values should be taken into account and not compensated with very low values. The formula will only use electric field strengths where users are active as opposed to \cite{J1} where the area is divided into grids and the exposure is calculated for every gridpoint. The reasoning behind this is that the goal of this master dissertation is to calculate the average exposure of the user and not of the entire area.

The formula first calculates the index where the mean value and the 95th percentile should be located. Afterwards, the exposure is calculated using interpolation if necessary.

\begin{algorithm}
	\caption{globalUserExpsoure} 
	\label{alg:getglobaluserexposure}
     \hspace*{\algorithmicindent} \textbf{Input} users[], $w_1$, $w_2$\\
     \hspace*{\algorithmicindent} \textbf{Output} Weighted average of the median  and the $95th$ percentile electric field strenght
	\begin{algorithmic}[1]
		\State Sort users by $E_{tot}$
		
 		\Comment{E50}
		\State $meanIndex \gets \frac{users.length}{2}$
		\If{users.length \% 2 == 0}
			\State $E_{50} \gets users[meanIndex].exposure$ 
		\Else
			\State $E_{50} \gets \frac{(users[ \left \lceil{meanIndex}\right \rceil ].exposure) + (users[ \left \lfloor{meanIndex}\right \rfloor ].exposure)}{2}$ 
		\EndIf

		\Comment{E95 with interpolation}
		\State $ X \gets users.length * 0.95$ 
		\State $ X_1 \gets \left \lfloor{x}\right \rfloor $ 
		\State $ X_2 \gets \left \lceil{x}\right \rceil $ 
		\State $ Y_1 \gets users[X_1].exposure$ 
		\State $ Y_2 \gets users[X_2].exposure$ 
		\State $E_{95} \gets  Y_1 + \left(\frac{(X - X_1)}{(X_2 - X_1)}* (Y_2 - Y_1)\right)$\\
		\Return $\frac{(w_1* E_{50})+ (w_2 * E_{95})}{w_1 + w_2}$
	\end{algorithmic} 
\end{algorithm}

%%%%%%%%%%%%%%%%%%%%%%%%% SECTIOIN %%%%%%%%%%%%%%%%%%%%%%%%
\section{Implementation of uplink exposure}
\label{sec:uplinkexposure}

Analogously to the \ref{sec:downlinkimplementation}, the uplink calculator will determine the uplink exposure and save in the appropriate user object. The calculator starts with iterating over each user in each simulation and calls the getSar() function.

\ref{eq:sar10g} is implemented in \ref{algo:getsar}. The function requires a user as input for which the uplink exposure should be calculated and two constant values which should be declared once. The maximal allowed $SAR_{10g}$ as discussed in \ref{sec:sar} and maximal permitted transmission power of 23 dbm.

Also, the actual transmitting power of the \gls{UE} needs to be calculated using the getActualTransmitPower function. 

Both $Tx_{watt}$ and $TX^{max}_{watt}$ are converted to watt. This is because the decibel variant can range from -57 dBm to 23 dBm \cite{J10_RDPgit}. Converting to Watt results in a solely positive fraction. 

After having multiplied with the maximum allowable \gls{SAR}, the actual uplink exposure is returned.

\begin{algorithm}
	\caption{getSar} 
	\label{alg:getsar}
     \hspace*{\algorithmicindent} \textbf{Input} user \\
     \hspace*{\algorithmicindent} \textbf{Output} $SAR_{10g}$
	\begin{algorithmic}[1]
		\State  const $SAR^{max} \gets 0.67$
		\State  const $TX^{max}_{watt} \gets dBm2W(23)$
		\vspace{4 mm}
		\State $Tx_{watt} \gets dBm2W(getActualTransmitPower(user)) $		
		\State $ SAR_{10g} \gets \frac{Tx_{watt}}{TX^{max}_{watt}} * SAR^{max}$ \\
		\Return $ SAR_{10g}$
	\end{algorithmic} 
\end{algorithm}


The implementation for getActualTransmitPower is described in \ref{alg:getActualTransmitPower}. This function requires a user as a parameter and will calculate the real used power for transmission in dBm.
Once again, a global constant value is defined describing the maximum allowable transmitting power $Tx^{max}_{dBm}$ expressed in dBm. The predicted transmitting power is achieved by subtracting the path loss between the user and the affective femtocell with the receiver sensitivity of the femtocell. However, this value can't be higher then  $Tx^{max}_{dBm}$ , if this is the case the maximum allowable transmitting power is returned instead.

\begin{algorithm}
	\caption{getActualTransmitPower} 
	\label{alg:getActualTransmitPowergit}
     \hspace*{\algorithmicindent} \textbf{Input} user \\
     \hspace*{\algorithmicindent} \textbf{Output} The actual used power for transmition in dBm.
	\begin{algorithmic}[1]
		\State const $Tx^{max}_{dBm} \gets 23$
		\vspace{4 mm}
		\State $ Tx_{dBm} \gets user.getPathLoss() - technology.getFemtocellReceiverSensitivity(user.getRxSNR)$ \\
		\Return $min(Tx_{dBm}, Tx^{max}_{dBm})$ 
	\end{algorithmic} 
\end{algorithm}


%\begin{algorithm}
%	\caption{getFemtocellReceiverSensitivity} 
%	\label{alg:getFemtocellReceiverSensitivity}
%     \hspace*{\algorithmicindent} \textbf{Input} user \\
%     \hspace*{\algorithmicindent} \textbf{Output} The receiver sensitivity of the femtocell in dBm
%	\begin{algorithmic}[1]
%		\State $SNR \gets user.getRxSNR$
%		\State $gain \gets technology.getMSantennagain$
%		\State $implementationLoss \gets technology.getImplementationLoss$
%		\State $interferenceMargin \gets technology.getCellInterferenceMargin$
%		\State $noiseFigure \gets technology.getNoiseFigure$
%		\State $thermalNoise \gets -108.1$	\\
%		\Return  $thermalNoise + SNR - gain + implementationLoss + noiseFigure + interferenceMargin$
%	\end{algorithmic} 
%\end{algorithm}

